<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8"/>
    <title>游戏房间</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="assets/font-awesome/4.5.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="assets/font-awesome/4.5.0/css/all.min.css"/>
    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="assets/css/jquery-ui.min.css"/>
    <!-- text fonts -->

    <!-- ace styles -->
    <link rel="stylesheet" href="assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ace-part2.min.css" class="ace-main-stylesheet"/>
    <![endif]-->
    <link rel="stylesheet" href="assets/css/ace-skins.min.css"/>
    <link rel="stylesheet" href="assets/css/ace-rtl.min.css"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ace-ie.min.css"/>
    <![endif]-->

    <!-- inline styles related to this page -->

    <!-- ace settings handler -->
    <script src="assets/js/ace-extra.min.js"></script>

    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

    <!--[if lte IE 8]>
    <script src="assets/js/html5shiv.min.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->
</head>
<style>
    .player-holder-container {
        height: 50%;
        margin: 0;
    }

    .player-holder-top {
        height: 50%;
    }

    .player-holder-bottom {
        height: 50%;
        padding: 5%
    }

    .player-avatar-holder {
        height: 100%;
        width: 50%;
        border-right: 2px solid #2ECEE7;
        text-align: center;
    }

    .player-avatar {
        display: inline-block;
        width: 90px;
        height: 90px;
        border-radius: 100%;
        margin-top: 19%;
        margin-bottom: 12%;
        border: 2px solid #b1b1b1;
    }

    .player-status {
        height: 100%;
        width: 50%;
        text-align: center;
        cursor: default;
    }

    .player-status-span {
        display: inline-block;
        margin-top: 45%;
        border-radius: .25em;
        cursor: default;
    }

    .player-status-img{
        display: inline-block;
        margin-top: 45%;
        border-radius: 100%;
        cursor: default;
    }

    .game-info {
        width: 100%;
        height: 100%;
        padding: 5%;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        cursor: default;
    }

    .game-info-row {
        width: 100%;
        height: 25%;
        text-align: center;
    }

    .game-info-title {
        width: 50%;
        text-align: center;
        font-size: 155%;
        font-weight: 700;
    }

    .game-info-content {
        width: 50%;
        text-align: center;
        font-size: 155%;
        font-weight: 700;
    }

    .middle-part-container{
        display: flex;
        flex-direction: column;
        justify-content: space-around;
    }

    .game-pad-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        text-align: center;
    }

    .game-button-container {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        width: 700px;
        margin-top: 5px;
    }

    .my-foot {
        margin-top: 5px;
        line-height: 35px;
        border-top: 3px double #E5E5E5;
    }

    .foot-title {
        text-align: center;
        display: block;
        margin-top: 5px
    }

    td {
        font-weight: 700;
    }

    .message-input-wrapper {
        height: 25%;
        background: repeat-x #f7f7f7;
        border-bottom: 1px solid #DDD;
    }

    #message-input {
        width: 80%;
        height: 50%;
        margin-top: 5%;
        margin-left: 10%;
    }

    .player-info-container {
        height: 60%;
        margin: 0;
    }

    .flex-column {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
    }

    .player-info-row {
        width: 100%;
        height: 20%;
    }

    .player-info-title {
        width: 40%;
        padding-right: 15px;
        font-size: 140%;
        font-weight: 700;
        text-align: right;
    }

    .player-info-content {
        width: 60%;
        font-size: 140%;
        font-weight: 700;
        text-align: left;
    }

    .player-info-avatar-holder {
        width: 40%;
        height: 50%;
        text-align: center;
    }

    .player-info-avatar {
        display: inline-block;
        width: 80px;
        height: 80px;
        border-radius: 100%;
        margin-top: 19%;
        margin-bottom: 12%;
        border: 1px solid #b1b1b1;
    }

    .progress-label {
        position: absolute;
        left: 50%;
        font-weight: bold;
        color: #888;
    }

    .message-container{
        height:100%;
        border: 1px rgb(204, 204, 204) solid;
    }

    .message-to-me {
        background: #6FB3E0;
        border-radius: 12px;
        padding: 5px;
        color: white;
        cursor: default;
    }

    .message-wrapper {
        margin: 5px;
    }

    .chess-point{
        width: 10px;
        height: 10px;
    }
    .chess-point-enable{
        cursor: pointer;
    }
    .chess-point-disable{
        cursor: not-allowed;
    }

    .width-24 {
        width: 24% !important;
    }

    .height-40{
        height: 40% !important;
    }

    .height-50 {
        height: 50% !important;
    }

    .height-60 {
        height: 60% !important;
    }

    .height-75 {
        height: 75% !important;
    }

    .height-100 {
        height: 100% !important;
    }
</style>
<body class="no-skin">
<div id="navbar" class="navbar navbar-default">
    <div class="navbar-container ace-save-state">
        <div class="navbar-header">
            <a href="javascript:void(0);" class="navbar-brand" style="cursor: default">
                <small>
                    游戏房间
                </small>
            </a>
        </div>
        <div class="navbar-buttons navbar-header pull-right" role="navigation">
            <div id="btn-return" class="btn btn-info"><i class="fa fa-sign-out-alt"></i>返回游戏大厅</div>
        </div>

    </div><!-- /.navbar-container -->
</div>

<div class="main-container">
    <div class="main-content">
        <div class="main-content-inner">
            <div class="page-content no-padding">
                <div class="row no-margin">
                    <div class="left-part-container col-xs-3 pull-left no-padding">
                        <div id="left" class="well player-holder-container">
                            <div class="panel panel-info" style="width: 100%;height: 100%;display: flex;flex-direction: row;justify-content: center;align-items: center;">
                                <span class="label label-xlg">空位待坐</span>
                            </div>
                            <!--<div class="panel panel-info no-margin player-holder-top">-->
                                <!--<div class="pull-left player-avatar-holder">-->
                                    <!--<img class="player-avatar" src="assets/images/avatars/avatar2.png"/>-->
                                    <!--<div class="width-80 label label-info label-xlg arrowed-in arrowed-in-right center">-->
                                        <!--username-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="pull-right player-status">-->
                                    <!--<span class="label label-xlg  label-info player-status-span">未准备</span>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="panel panel-info no-margin player-holder-bottom">-->
                                <!--<div class="game-info label label-success">-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>局时:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>10 - 00</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>步时:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>00 - 00</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>比分:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>0</span>-->
                                        <!--</div>-->

                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                        </div>
                        <div id="right" class="well player-holder-container">
                            <!--<div class="panel panel-info no-margin player-holder-top">-->
                                <!--<div class="pull-left player-avatar-holder">-->
                                    <!--<img class="player-avatar" src="assets/images/avatars/avatar2.png"/>-->
                                    <!--<div class="width-80 label label-info label-xlg arrowed-in arrowed-in-right center">-->
                                        <!--username-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="pull-right player-status">-->
                                    <!--<span class="label label-xlg  label-info player-status-span">未准备</span>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="panel panel-info no-margin player-holder-bottom">-->
                                <!--<div class="game-info label label-success">-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>局时:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>10 - 00</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>步时:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>00 - 00</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <!--<div class="game-info-row">-->
                                        <!--<div class="game-info-title pull-left">-->
                                            <!--<span>比分:</span>-->
                                        <!--</div>-->
                                        <!--<div class="game-info-content pull-right">-->
                                            <!--<span>0</span>-->
                                        <!--</div>-->

                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                            <div class="panel panel-info" style="width: 100%;height: 100%;display: flex;flex-direction: row;justify-content: center;align-items: center;">
                                <span class="label label-xlg">空位待坐</span>
                            </div>
                        </div>
                    </div>
                    <div class="no-margin middle-part-container no-padding col-xs-6">
                        <div class="no-margin no-padding game-pad-container">
                            <canvas class="no-margin" id="canvas" height="700" width="700"
                                    style="background-image: url(assets/images/game/bak.jpg);background-size:cover;display: inline-block;"></canvas>

                            <div class="game-button-container">
                                <div class="btn  btn-info disabled">悔棋</div>
                                <div id="beg-draw"   class="btn  btn-info disabled">和棋</div>
                                <div id="ready-btn" class="btn  btn-info">准备</div>
                                <div id="give-up" class="btn  btn-info disabled">认输</div>
                                <div class="btn  btn-info disabled">保存</div>
                            </div>
                        </div>
                        <div class="my-foot">
                            <span class="bigger-120 foot-title">
                                <span class="blue bolder">五子棋游戏系统</span>
                                version 2.0.1
                            </span>
                        </div>
                    </div>
                    <div class="right-part-container col-xs-3 no-padding pull-right">
                        <div class="player-info-container">
                            <div id="widget-1" class="widget-box no-margin widget-color-grey height-60">
                                <div class="widget-header">
                                    <h5 class="widget-title bigger lighter"><i class="ace-icon fa fa-user"></i>用户信息</h5>
                                </div>
                                <div class="widget-body">
                                    <div class="widget-main no-padding height-100">
                                        <div class="pull-left label label-light width-60 height-50 flex-column">
                                            <div class="player-info-row">
                                                <div class="player-info-title pull-left">
                                                    <span>用户名:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <span id="pdi-username"></span>
                                                </div>
                                            </div>
                                            <div class="player-info-row">
                                                <div class="player-info-title pull-left">
                                                    <span>性别:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <span id="pdi-sex"></span>
                                                </div>
                                            </div>
                                            <div class="player-info-row">
                                                <div class="player-info-title pull-left">
                                                    <span>生日:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <span id="pdi-birthday">1996-04-08</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pull-right player-info-avatar-holder">
                                            <img class="player-info-avatar" id="pdi-avatar" src="assets/images/avatars/avatar2.png"/>
                                        </div>
                                        <div class="label label-light width-100 height-50 flex-column">
                                            <div class="player-info-row width-60">
                                                <div class="player-info-title pull-left">
                                                    <span>总场数:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <span id="pdi-game-time">0</span>
                                                </div>
                                            </div>
                                            <div class="player-info-row width-60">
                                                <div class="player-info-title pull-left">
                                                    <span>平局次数:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <span id="pdi-draw-time">0</span>
                                                </div>
                                            </div>
                                            <div class="player-info-row">
                                                <div class="player-info-title pull-left width-24">
                                                    <span>胜率:</span>
                                                </div>
                                                <div class="player-info-content pull-left">
                                                    <div id="progressbar"><span class="progress-label">0%</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="widget-2" class="widget-box no-margin widget-color-blue2 height-40">
                                <div class="widget-header">
                                    <h5 class="widget-title bigger lighter"><i class="fas fa-table" style="margin-right: 5px;"></i>房间用户列表
                                    </h5>
                                </div>
                                <div class="widget-body">
                                    <div class="widget-main no-padding ">
                                        <table class="table table-striped table-bordered table-hover"
                                               style="border-bottom: 1px rgb(221, 221, 221) solid">
                                            <thead>
                                            <tr>
                                                <th class="center">
                                                    用户名
                                                </th>
                                                <th class="center">
                                                    QQ
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody id="player-list">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="widget-3" class="widget-box no-margin widget-color-blue3 height-40">
                            <div class="widget-header">
                                <h5 class="widget-title bigger lighter"><i class="ace-icon fa fa-comment"></i>局内消息</h5>
                            </div>
                            <div class="widget-body" >
                                <div class="widget-main no-padding height-100">
                                    <div class="message-container">
                                        <div id="message-content-wrapper" class="clearfix height-75">
                                            <div id="message-content">
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                                <!--<div class="message-wrapper">-->
                                                    <!--<div style="font-weight: bold">test-username:</div>-->
                                                    <!--<div class="message-to-me"-->
                                                         <!--style="display: inline-block;margin-left: 10px">我回复了你的消息-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                            </div>
                                        </div>
                                        <div class="message-input-wrapper">
                                            <input id="message-input" type="text"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->


</div><!-- /.main-container -->

<!-- basic scripts -->

<!--[if !IE]> -->
<script src="assets/js/jquery-2.1.4.min.js"></script>

<!-- <![endif]-->

<!--[if IE]>
<script src="assets/js/jquery-1.11.3.min.js"></script>
<![endif]-->
<script type="text/javascript">
    if ('ontouchstart' in document.documentElement) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>" + "<" + "/script>");
</script>
<script src="assets/js/bootstrap.min.js"></script>

<!-- page specific plugin scripts -->
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
<script src="assets/js/jquery.cookie.js"></script>
<script src="assets/layui/layui.all.js"></script>
<script src="assets/js/jquery.slimscroll.min.js"></script>
<!-- ace scripts -->
<script src="assets/js/ace-elements.min.js"></script>
<script src="assets/js/ace.min.js"></script>

<!-- inline scripts related to this page -->
</body>
<script>
    $(document).ready(function () {
        init();

        //判断页面刷新与关闭代码
        var beforeUnloadTime = 0,
            gapTime = 0;
        var isFireFox = navigator.userAgent.indexOf("Firefox") > -1; //是否是火狐浏览器
        window.onunload = function() {
            gapTime = new Date().getTime() - beforeUnloadTime;
            if (gapTime <= 5) {
                $.ajax({
                    type: "POST",
                    url: "ExitGameRoom"
                });
            }
        };
        window.onbeforeunload = function() {
            ws.close();
            beforeUnloadTime = new Date().getTime();
            if (isFireFox){
                $.ajax({
                    type: "POST",
                    url: "ExitGameRoom"
                });
            } //火狐关闭执行
        };
    });

    //页面初始化函数
    function init(){
        //加载image以便后续使用
        blackChess=new Image();
        blackChess.src = "assets/images/game/black.png";
        whiteChess=new Image();
        whiteChess.src = "assets/images/game/white.png";

        //闪烁提示动画
        var changeFlag=0;
        function flash(){
            if (!changeFlag) {
                $(".image-alert").show();
                changeFlag = 1;
            } else {
                $(".image-alert").hide();
                changeFlag = 0;
            }
        }
        setInterval(flash,500);

        cssSetting();

        $("#progressbar").progressbar({
            value: 0,
            create: function (event, ui) {
                $(this).addClass('progress progress-striped active');
                $("#progressbar>div").addClass('progress-bar progress-bar-success');
            }
        });

        getGameRoomData();

        loadPlayerList();

        $("#player-list > tr:first").trigger("onclick");

        let userId=GameRoomData.whoGet;

        loadPlayerHolder();

        initGamePad();

        initChessPoint();

        loadChess();

        loadCoverDiv(userId);

        loadButtonGroup(userId);

        connectWebSocket();

        //游戏中点击棋点下棋的点击事件
        $("body").on("click", ".chess-point", function () {
            let chessType = GameRoomData.gameInfo.playerState[userId].chessType;
            let x = $(this).data("x");
            let y = $(this).data("y");
            //TODO(MICHAEL)发送下棋的http请求
            $.ajax({
                type:"post",
                url:"PutChess",
                data:{"chessType":chessType,"x":x,"y":y},
                success:function (data) {
                    if(data.status=="00"){
                        getGameRoomData();
                        let userId=GameRoomData.whoGet;
                        initChessPoint();
                        loadChess();
                        loadCoverDiv(userId);
                        loadPlayerHolder();
                    }
                }
            });
        });

        //准备按钮点击事件
        $("#ready-btn").click(function () {
            var userId=GameRoomData.whoGet;
            var playerInfo=GameRoomData.playerInfo;
            var readyState=0;
            for(var i=0;i<playerInfo.length;i++){
                if(playerInfo[i].userId==userId){
                    readyState=playerInfo[i].readyState;
                    break;
                }
            }
            if(readyState==0){
                $(".player-status[data-id="+userId+"]>span").text("已准备");
                $("#ready-btn").text("取消准备");
            }else{
                $(".player-status[data-id="+userId+"]>span").text("未准备");
                $("#ready-btn").text("准备");
            }

            $.ajax({
                type:"POST",
                url:"Ready",
                data:{"readyState":readyState}
            });
        });

        $("#btn-return").click(function(){
            ws.close();
            $.ajax({
                type: "POST",
                url: "ExitGameRoom",
                async:false,
                success:function () {
                    window.close();
                }
            });
        });

        $(window).resize(function () {
            let userId=GameRoomData.whoGet;
            cssSetting();

            initChessPoint();

            loadCoverDiv(userId);
        });

        //发送消息事件
        $(document).keyup(function (e) {
            if (e.keyCode == 13) {
                var message = $("#message-input").val();
                if (isEmpty(message)) {
                    return;
                }
                let userId=GameRoomData.whoGet;
                let username;
                let playerInfo=GameRoomData.playerInfo;
                for(let i=0;i<playerInfo.length;i++){
                    if(playerInfo[i].userId==userId){
                        username=playerInfo[i].username;
                        break;
                    }
                }
                message = htmlEncode(message);
                sendMessage(message);
                insertMessage(username, message);
                $("#message-input").val("");
                $("#message-content").slimScroll({scrollBy: '300px'});
            }
        });

        //创建提醒
        layer.msg("请不要在对局开始后关闭页面或退出游戏房间，这样会导致你输掉对局！",{time:2000});

        $("#give-up").click(function () {
            layer.confirm("确定要认输嘛？",function (index) {
                $.ajax({
                    type:"POST",
                    url:"GiveUp"
                });
                layer.close(index);
            })
        });
        $("#beg-draw").click(function () {
            layer.confirm("确定要求和嘛？",function (index) {
                $.ajax({
                    type:"POST",
                    url:"BegDraw"
                });
                layer.close(index);
            })
        });
    }

    //连接websocket
    //TODO(michael)上线时更改url
    function connectWebSocket(){
        ws=new WebSocket("ws://www.mytest.com:8088/wuziqi/GameRoomWebSocket");
        ws.onopen=function () {
            sendHeartPackage();
        };
        ws.onmessage=function (e) {
            var data = eval('(' + e.data + ')');
            //刷新页面
            if (data["type"] == "00") {
                window.location.reload();
            }

            //回复心跳包
            if (data["type"] == "01") {
                sendHeartPackage();
            }

            //开始游戏
            if (data["type"] == "02") {
                getGameRoomData();
                let userId=GameRoomData.whoGet;
                loadPlayerHolder();
                initChessPoint();
                loadChess();
                loadCoverDiv(userId);
                loadButtonGroup(userId);
                showNotice("对局开始！")
            }

            //刷新player-status
            if(data["type"] == "03"){
                getGameRoomData();
                loadPlayerHolder();
            }

            //处理后台交换期权请求
            if (data["type"] == "04") {
                getGameRoomData();
                let userId=GameRoomData.whoGet;
                loadPlayerHolder();
                loadChess();
                initChessPoint();
                loadCoverDiv(userId);
                showNotice("轮到你啦！")
            }

            if (data["type"] == "05") {
                getGameRoomData();
                let userId=GameRoomData.whoGet;
                if (userId==data.winnerId){
                    layer.alert("恭喜你获胜了！")
                } else{
                    layer.alert("很遗憾你输了！")
                }
                loadPlayerHolder();
                loadCoverDiv(userId);
                loadButtonGroup(userId);
                $("#player-list > tr:first").trigger("onclick");
            }

            if (data["type"] == "06") {
                getGameRoomData();
                let userId=GameRoomData.whoGet;
                layer.alert("平局！");
                loadPlayerHolder();
                loadCoverDiv(userId);
                loadButtonGroup(userId);
                $("#player-list > tr:first").trigger("onclick");
            }

            if (data["type"] == "07") {
                alert("对手逃离！你获胜了！");
                setTimeout(function () {
                    window.location.reload();
                },500)
            }

            //插入消息
            if (data["type"] == "08") {
                var content=data["data"];
                let userId=GameRoomData.whoGet;
                let username;
                let playerInfo=GameRoomData.playerInfo;
                for(let i=0;i<playerInfo.length;i++){
                    if(playerInfo[i].userId!=userId){
                        username=playerInfo[i].username;
                        break;
                    }
                }
                insertMessage(username, content);
                $("#dialog-content").slimScroll({scrollBy: '300px'});
            }

            //认输
            if(data["type"]=="09"){
                getGameRoomData();
                let userId=GameRoomData.whoGet;
                if (userId==data.looserId){
                    layer.alert("你认输了！")
                } else{
                    layer.alert("恭喜你赢了！对手认输！")
                }
                loadPlayerHolder();
                loadCoverDiv(userId);
                loadButtonGroup(userId);
                $("#player-list > tr:first").trigger("onclick");
            }

            //请求和棋
            if(data["type"]=="10"){
               layer.confirm("对手请求和棋",{
                   btn: ['同意', '拒绝'],
                   yes:function(index){
                       var data = {type: "02", result: "agree"};
                       var stringData = JSON.stringify(data);
                       ws.send(stringData);
                       layer.close(index);
                   },
                   btn2:function(index){
                       var data = {type: "02", result: "deny"};
                       var stringData = JSON.stringify(data);
                       ws.send(stringData);
                       layer.close(index);
                   }
               })
            }

            //拒绝和棋
            if(data["type"]=="11"){
                layer.alert("对手拒绝和棋！");
            }

            //关闭页面
            if(data["type"]=="12"){
                window.close();
            }
        };
    }

    //设置css
    function cssSetting(){
        var height = $(window).height() - $("#navbar").height();
        $(".right-part-container").height(height);
        $(".middle-part-container").height(height);
        $(".left-part-container").height(height);
        var widget1BodyHeight=$("#widget-1").height()-39;
        $("#widget-1>.widget-body").height(widget1BodyHeight);
        var widget2BodyHeight=$("#widget-2").height()-39;
        $("#widget-2>.widget-body").height(widget2BodyHeight);
        var widget3BodyHeight=$("#widget-3").height()-39;
        $("#widget-3>.widget-body").height(widget3BodyHeight);
        var messageContentHeight=$("#message-content-wrapper").height();
        $("#message-content").slimScroll({
            height: messageContentHeight+"px",
            start: "bottom"
        });
    }

    //初始化canvas
    function initGamePad() {
        var canvas=document.getElementById("canvas");
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,700,700);
        ctx.lineWidth=1;
        ctx.strokeStyle = 'black';
        ctx.strokeRect(30,30,14*45,14*45);
        for(var i=0;i<13;i++){
            ctx.beginPath();
            ctx.moveTo(30+45*(i+1),30);
            ctx.lineTo(30+45*(i+1),30+45*14);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(30,30+45*(i+1));
            ctx.lineTo(30+45*14,30+45*(i+1));
            ctx.stroke();
        }
        ctx.fillRect(160,160,10,10);
        ctx.fillRect(160,520,10,10);
        ctx.fillRect(520,160,10,10);
        ctx.fillRect(520,520,10,10);
        ctx.fillRect(340,340,10,10);
        
    }
    //加载棋点
    function initChessPoint(){
        $(".chess-point").remove();
        if(GameRoomData.gameState==1){
            let pointState=GameRoomData.gameInfo.pointState;
            var canvas=document.getElementById("canvas");
            for(var x=0;x<pointState.length;x++){
                var coloum=pointState[x];
                for(var y=0;y<coloum.length;y++) {
                    var position=indexToMousePos([x,y],canvas);
                    if(pointState[x][y]==0){
                        $("body").append("<div class=\"chess-point chess-point-enable\" data-x=\""+x+"\" data-y=\""+y+"\" style=\"position: fixed;left:"+(position[0]-5)+"px;top:"+(position[1]-5)+"px; z-index: 5;\"></div>");
                    }else{
                        $("body").append("<div class=\"chess-point chess-point-disable\" data-x=\""+x+"\" data-y=\""+y+"\" style=\"position: fixed;left:"+(position[0]-5)+"px;top:"+(position[1]-5)+"px; z-index: 5;\"></div>");
                    }
                }
            }
        }

    }
    //画棋子
    function drawChess(ctx,chessType,newIndexX,newIndexY,oldChessType,oldIndexX,oldIndexY) {
        newIndexX=parseInt(newIndexX);
        newIndexY=parseInt(newIndexY);
        var newPoint=indexToCanvasPoint([newIndexX,newIndexY]);
        var newX=newPoint[0];
        var newY=newPoint[1];
        if(chessType=="black"){
            chessType=blackChess;
        }else{
            chessType=whiteChess;
        }
        ctx.drawImage(chessType,newX-22,newY-22,44,44);
        ctx.lineWidth=4;
        ctx.strokeStyle = 'red';
        ctx.beginPath();
        ctx.moveTo(newX-10,newY);
        ctx.lineTo(newX+10,newY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(newX,newY-10);
        ctx.lineTo(newX,newY+10);
        ctx.stroke();
        if(oldChessType!=undefined){
            if(oldChessType=="black"){
                oldChessType=blackChess;
            }else{
                oldChessType=whiteChess;
            }
            oldIndexX=parseInt(oldIndexX);
            oldIndexY=parseInt(oldIndexY);
            var oldPoint=indexToCanvasPoint([oldIndexX,oldIndexY]);
            var oldX=oldPoint[0];
            var oldY=oldPoint[1];
            ctx.drawImage(oldChessType,oldX-22,oldY-22,44,44);
        }
    }

    function indexToCanvasPoint(index){
        var xIndex=index[0];
        var yIndex=index[1];
        var x=xIndex*45+30;
        var y=yIndex*45+30;
        return [x,y]
    }

    //将对应棋盘内的index转化为屏幕的left和top值
    function indexToMousePos(index,canvas) {
        var rect = canvas.getBoundingClientRect();
        var left= index[0]*45+30+rect.left;
        var top=index[1]*45+30+rect.top;
        return[left,top];
    }

    //发送获取GameRoomData请求，并产生全局变量GameRoomData
    function getGameRoomData() {
        $.ajax({
            type:"get",
            url:"GetGameRoomData",
            async:false,
            success:function (data) {
                GameRoomData=data;
            }
        })
    }

    //加载屏幕右侧的玩家列表
    function loadPlayerList(){
        $("#player-list").empty();
        var playerInfo=GameRoomData.playerInfo;
        for(var i=0;i<playerInfo.length;i++){
            var row=playerInfo[i];
            var tr=$("<tr style=\"cursor: pointer;\" onclick=\"loadPlayerDetailInfo("+i+")\"></tr>");
            var nameTd=$("<td class=\"center\"></td>");
            nameTd.text(row.username);
            var qqTd=$("<td class=\"center\"></td>");
            if(isEmpty(row.qq)){
                qqTd.text("未填写");
            }else{
                qqTd.text(row.qq);
            }
            tr.append(nameTd).append(qqTd);
            $("#player-list").append(tr);
        }
    }

    //加载屏幕右侧的玩家详细列表
    function loadPlayerDetailInfo(rowIndex) {
        var row=GameRoomData.playerInfo[rowIndex];
        //avatar
        $("#pdi-avatar").attr("src",row.avatar);
        //用户名
        $("#pdi-username").text(row.username);
        //性别
        if(isEmpty(row.sex)){
            $("#pdi-sex").text("未填写");
        }
        if(row.sex==0){
            $("#pdi-sex").text("男");
        }
        if(row.sex==1){
            $("#pdi-sex").text("女");
        }
        //生日
        if(isEmpty(row.birthday)){
            $("#pdi-birthday").text("未填写");
        }else{
            $("#pdi-birthday").text(row.birthday);
        }
        //总场数
        $("#pdi-game-time").text(row.gameTime);
        //平局次数
        $("#pdi-draw-time").text(row.drawTime);
        //胜率
        var winRate;
        if(row.gameTime==0){
            winRate=0
        }else{
            winRate=Math.round(row.winTime/row.gameTime*100);
        }
        $("#progressbar>.progress-label").text(winRate+"%");
        $("#progressbar").progressbar({value: winRate});
    }

    //加载左侧playerHolder
    function loadPlayerHolder(){
        var playerInfo=GameRoomData.playerInfo;
        var length=playerInfo.length;
        for(let i=0;i<length;i++){
            var row=playerInfo[i];
            if(row.position=="left"){
                $("#left").empty();
                var appendHtml=$("<div class=\"panel panel-info no-margin player-holder-top\" data-id=\""+row.userId+"\">\n" +
                    "                                <div class=\"pull-left player-avatar-holder\">\n" +
                    "                                    <img class=\"player-avatar\" src=\""+row.avatar+"\"/>\n" +
                    "                                    <div class=\"width-80 label label-info label-xlg arrowed-in arrowed-in-right center\">\n" +
                    "                                        "+row.username+"\n" +
                    "                                    </div>\n" +
                    "                                </div>\n" +
                    "                                <div class=\"pull-right player-status\" data-id=\""+row.userId+"\">\n" +
                    "                                    <span class=\"label label-xlg  label-info player-status-span\">未准备</span>\n" +
                    "                                </div>\n" +
                    "                            </div>\n" +
                    "                            <div class=\"panel panel-info no-margin player-holder-bottom\" data-id=\""+row.userId+"\">\n" +
                    "                                <div class=\"game-info label label-success\">\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>局时:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>10 - 00</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>步时:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>00 - 00</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>比分:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>0</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                </div>\n" +
                    "                            </div>");
                $("#left").append(appendHtml);
            }
            if(row.position=="right"){
                $("#right").empty();
                var appendHtml=$("<div class=\"panel panel-info no-margin player-holder-top\" data-id=\""+row.userId+"\">\n" +
                    "                                <div class=\"pull-left player-avatar-holder\">\n" +
                    "                                    <img class=\"player-avatar\" src=\""+row.avatar+"\"/>\n" +
                    "                                    <div class=\"width-80 label label-info label-xlg arrowed-in arrowed-in-right center\">\n" +
                    "                                        "+row.username+"\n" +
                    "                                    </div>\n" +
                    "                                </div>\n" +
                    "                                <div class=\"pull-right player-status\" data-id=\""+row.userId+"\">\n" +
                    "                                    <span class=\"label label-xlg  label-info player-status-span\">未准备</span>\n" +
                    "                                </div>\n" +
                    "                            </div>\n" +
                    "                            <div class=\"panel panel-info no-margin player-holder-bottom\" data-id=\""+row.userId+"\">\n" +
                    "                                <div class=\"game-info label label-success\">\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>局时:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>10 - 00</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>步时:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>00 - 00</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <div class=\"game-info-row\">\n" +
                    "                                        <div class=\"game-info-title pull-left\">\n" +
                    "                                            <span>比分:</span>\n" +
                    "                                        </div>\n" +
                    "                                        <div class=\"game-info-content pull-right\">\n" +
                    "                                            <span>0</span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                </div>\n" +
                    "                            </div>");
                $("#right").append(appendHtml);

            }
            loadPlayerStatus(row.userId);
            loadGamePannel(row.userId);
        }
    }

    //userId为plyaerInfo中的userId
    function loadPlayerStatus(userId) {
        $(".player-holder-top[data-id='"+userId+"']>.player-status").empty();
        let gameState=GameRoomData.gameState;
        let playerReadyState;
        let chessType;
        let myTurn;
        if(gameState==0){
            let playerInfo=GameRoomData.playerInfo;
            for(let i=0;i<playerInfo.length;i++){
                if(playerInfo[i].userId==userId){
                    playerReadyState=playerInfo[i].readyState;
                    break;
                }
            }
        }else{
            let gameInfo=GameRoomData.gameInfo;
            chessType=gameInfo.playerState[userId].chessType;
            myTurn=gameInfo.playerState[userId].myTurn;
        }
        let insertHtml;
        if(gameState==0){
            insertHtml=$("<span class=\"label label-xlg  label-info player-status-span\">未准备</span>");
            if(playerReadyState==1){
                insertHtml.text("已准备")
            }
        }else{
            insertHtml=$("<img class='player-status-img' src='assets/images/game/black.png'/>");
            if(chessType=="white"){
                insertHtml.attr("src","assets/images/game/white.png");
            }
            if(myTurn){
                insertHtml.addClass("image-alert");
            }
        }
        $(".player-holder-top[data-id='"+userId+"']>.player-status").append(insertHtml);
    }

    //TODO(MICHAEL)目前只做胜利次数的刷新别的暂时不做
    //userId为plyaerInfo中的userId
    function loadGamePannel(userId) {
        let gameInfo=GameRoomData.gameInfo;
        let winTime=0;
        if(gameInfo!=undefined){
            winTime=gameInfo.playerState[userId].winTime;
        }
        $(".player-holder-bottom[data-id='"+userId+"']>.game-info>.game-info-row:last>.game-info-content>span").text(winTime);
    }

    //参数userId为whoGet的Id
    function loadCoverDiv(userId){
        $(".cover-div").remove();
        let gameState=GameRoomData.gameState;
        let myTurn;
        if(gameState==1){
            let gameInfo=GameRoomData.gameInfo;
            myTurn=gameInfo.playerState[userId].myTurn;
        }
        if(gameState==0 || (gameState==1 && !myTurn)){
            let div=$("<div class='chess-point-disable cover-div' style='width:700px;height: 700px;position: fixed;z-index: 999;'></div>");
            let rect = document.getElementById("canvas").getBoundingClientRect();
            let left=rect.left;
            let top=rect.top;
            div.css("left",left+"px").css("top",top+"px");
            $("body").append(div);
        }

    }

    //加载棋子
    function loadChess() {
        let gameInfo=GameRoomData.gameInfo;
        if(gameInfo != undefined){
            let length=gameInfo.stepRecord.length;
            if(length!=0){
                let ctx = document.getElementById("canvas").getContext('2d');
                initGamePad();
                for(let j=0;j<length;j++){
                    let row=gameInfo.stepRecord[j];
                    if(j==0){
                        drawChess(ctx,row.chessType,row.point[0],row.point[1]);
                    }else{
                        let oldRow=gameInfo.stepRecord[j-1];
                        drawChess(ctx,row.chessType,row.point[0],row.point[1],oldRow.chessType,oldRow.point[0],oldRow.point[1]);
                    }
                }
            }else {
                initGamePad();
            }
        }
    }

    //TODO(MICHAEL)目前只加载准备按钮别的暂时不做
    //参数userId为whoGet的Id
    function loadButtonGroup(userId){
        let gameState=GameRoomData.gameState;
        if(gameState==0){
            let playerReadyState;
            let playerInfo=GameRoomData.playerInfo;
            for(let i=0;i<playerInfo.length;i++){
                if(playerInfo[i].userId==userId){
                    playerReadyState=playerInfo[i].readyState;
                    break;
                }
            }
            $("#beg-draw").addClass("disabled");
            $("#give-up").addClass("disabled");
            if(playerReadyState==0){
                $("#ready-btn").removeClass("disabled");
                $("#ready-btn").text("准备");
            }else{
                $("#ready-btn").text("取消准备");
            }
        }else{
            $("#ready-btn").addClass("disabled");
            $("#beg-draw").removeClass("disabled");
            $("#give-up").removeClass("disabled");
        }
    }
    //发送心跳包
    function sendHeartPackage(){
        setTimeout(function () {
            var data={type:"00"};
            data=JSON.stringify(data);
            ws.send(data);
        },500000)
    }

    //桌面提醒
    function showNotice(message) {
        Notification.requestPermission(function (perm) {
            if (perm == "granted") {
                notification = new Notification(message);
            }
        })
    }

    function insertMessage(username,content) {
        var messageContent = $("#message-content");
        var insertHtml = "<div class=\"message-wrapper\">\n" +
            "                                                <div style=\"font-weight: bold\">"+username+":</div>\n" +
            "                                                <div class=\"message-to-me\"\n" +
            "                                                     style=\"display: inline-block;margin-left: 10px\">"+content+"\n" +
            "                                                </div>\n" +
            "                                            </div>";
        messageContent.append(insertHtml);
    }

    function sendMessage(message) {
        var data = {type: "01", message: message};
        var stringData = JSON.stringify(data);
        ws.send(stringData);
    }
    //html转义
    function htmlEncode(value) {
        return $('<div/>').text(value).html();
    }

    function isEmpty(obj) {
        return typeof obj == "undefined" || obj == null || obj == "";
    }

</script>
</html>
