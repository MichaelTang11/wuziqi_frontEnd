<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8"/>
    <title>五子棋游戏系统</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="assets/font-awesome/4.5.0/css/all.css"/>
    <link rel="stylesheet" href="assets/font-awesome/4.5.0/css/font-awesome.min.css"/>

    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="assets/css/jquery-ui.min.css"/>

    <!--<script src="assets/js/jquery.nestable.min.js"></script>-->
    <!-- text fonts -->
    <link rel="stylesheet" href="assets/css/fonts.googleapis.com.css"/>

    <!-- ace styles -->
    <link rel="stylesheet" href="assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ace-part2.min.css" class="ace-main-stylesheet"/>
    <![endif]-->
    <link rel="stylesheet" href="assets/css/ace-skins.min.css"/>
    <link rel="stylesheet" href="assets/css/ace-rtl.min.css"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="assets/css/ace-ie.min.css"/>
    <![endif]-->

    <!-- inline styles related to this page -->
    <style>
        .top-avatar{
            height: 40px;
            width: 40px;
        }

        .slide-img {
            display: inline-block;
            width: 36px;
            height: 36px;
            margin: -26px 0 0 0;
            border-radius: 100%;
            border: lightgrey solid 2px;
        }

        .slide-dd-handler {
            margin: 1px;
        }

        .margin-top8 {
            margin-top: 8px;
        }

        .margin-right5 {
            margin-right: 5px;
        }

        .no-padding-bottom {
            padding-bottom: 0;
        }

        .show-menu {
            cursor: pointer;

        }

        .table-wrapper {
            width: 153px;
            float: left;
            margin-left: 5px;
            margin-right: 5px;
        }

        .table-wrapper-main {
            height: 53px;
        }

        .player-name-left {
            height: 19px;
            color: white;
        }

        .player-holder-left {
            background: rgb(64, 85, 113);
            height: 35px;
            width: 35px;
            float: left;
            margin-top: 9px;
            margin-left: 10px;
            margin-right: 5px;
            border-radius: 100%;
            padding-top: 9px;
            color: rgb(104, 127, 158);
            cursor: pointer;
        }

        .player-holder-left-hp{
            background: rgb(64, 85, 113);
            height: 35px;
            width: 35px;
            float: left;
            margin-top: 9px;
            margin-left: 10px;
            margin-right: 5px;
            border-radius: 100%;
            color: rgb(104, 127, 158);
        }

        .img-table {
            border-radius: 25%;
            float: left;
        }

        .player-holder-image{
            border-radius: 100%;
            display: block;
            width: 35px;
            height: 35px;
        }

        .player-holder-right {
            background: rgb(64, 85, 113);
            height: 35px;
            width: 35px;
            float: left;
            margin-top: 9px;
            margin-left: 5px;
            margin-right: 10px;
            border-radius: 100%;
            padding-top: 9px;
            color: rgb(104, 127, 158);
            cursor: pointer;
        }

        .player-holder-right-hp{
            background: rgb(64, 85, 113);
            height: 35px;
            width: 35px;
            float: left;
            margin-top: 9px;
            margin-left: 5px;
            margin-right: 10px;
            border-radius: 100%;
            color: rgb(104, 127, 158);
        }

        .table-id {
            color: white;
            text-align: center;
        }

        .player-name-right {
            height: 19px;
            color: white;
            text-align: right;
        }

        .round-img {
            border-radius: 100%;
            border: lightgrey solid 2px;
        }

        .widget-title-round-img {
            display: inline-block;
            border-radius: 100%;
            border: lightgrey solid 2px;
        }

        .widget-title-text {
            display: inline-block;
            cursor: default;
        }

        .margin-top16 {
            margin-top: 16px;
        }

        .dialog-container {
            position: absolute;
            width: 550px;
            height: 368px;
            z-index: 1000;
            display: none;
        }

        .dialog-left-part {
            width: 200px;
            height: 368px;
            float: left;
            background: #F5F5F5;
        }

        .dialog-right-part {
            display: inline-block;
            width: 350px;
            height: 368px;
        }

        .message-wrapper {
            margin: 5px;
        }

        .message-to-me {
            float: left;
            background: #6FB3E0;
            border-radius: 12px;
            padding: 5px;
            color: white;
            cursor: default;
        }

        .message-to-other {
            float: right;
            background: #6FB3E0;
            border-radius: 12px;
            padding: 5px;
            color: white;
            cursor: default;
        }

        .time-stamp {
            margin: 30px 0;
            text-align: center;
            color: grey;
        }
    </style>
    <!-- ace settings handler -->
    <script src="assets/js/ace-extra.min.js"></script>

    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

    <!--[if lte IE 8]>
    <script src="assets/js/html5shiv.min.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript">

    </script>
</head>
<body class="no-skin">
<div id="navbar" class="navbar navbar-default ace-save-state">
    <div class="navbar-container ace-save-state" id="navbar-container">
        <button type="button" class="navbar-toggle menu-toggler pull-left" id="menu-toggler" data-target="#sidebar">
            <span class="sr-only">Toggle sidebar</span>

            <span class="icon-bar"></span>

            <span class="icon-bar"></span>

            <span class="icon-bar"></span>
        </button>

        <div class="navbar-header pull-left">
            <a href="javascript:void(0);" class="navbar-brand" style="cursor: default">
                <small>
                    <i class="fas fa-gamepad"></i>
                    五子棋游戏大厅
                </small>
            </a>
        </div>

        <div class="navbar-buttons navbar-header pull-right" role="navigation">
            <ul class="nav ace-nav">
                <li class="purple dropdown-modal">
                    <a id="top-open-info" style="cursor: pointer">
                        <i class="ace-icon fa fa-bell"></i>
                    </a>
                </li>

                <li class="green dropdown-modal">
                    <a id="top-open-dialog" style="cursor: pointer">
                        <i class="ace-icon fa fa-envelope icon-animated-vertical"></i>
                        <span class="badge badge-success">5</span>
                    </a>
                </li>

                <li class="light-blue dropdown-modal">
                    <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                        <img class="nav-user-photo top-avatar" src="assets/images/avatars/avatar2.png" alt="user avatar"/>
                        <span class="user-info">
                            <small>欢迎你</small>
                            <b id="username"></b>
                        </span>

                        <i class="ace-icon fa fa-caret-down"></i>
                    </a>

                    <ul class="user-menu dropdown-menu-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
                        <li>
                            <a id="setting" href="javascript:void(0);">
                                <i class="ace-icon fa fa-cog"></i>
                                设置
                            </a>
                        </li>

                        <li>
                            <a id="profile" href="javascript:void(0);">
                                <i class="ace-icon fa fa-user"></i>
                                个人信息
                            </a>
                        </li>

                        <li class="divider"></li>

                        <li>
                            <a id="logout" href="javascript:void(0);">
                                <i class="ace-icon fa fa-power-off"></i>
                                退出
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div><!-- /.navbar-container -->
</div>
<div class="main-container ace-save-state" id="main-container">

    <script type="text/javascript">
        try {
            ace.settings.loadState('main-container')
        } catch (e) {
        }
    </script>
    <div id="sidebar" class="sidebar position-absolute ace-save-state">
        <script type="text/javascript">
            try {
                ace.settings.loadState('sidebar')
            } catch (e) {
            }
        </script>
        <div class="widget-box no-padding no-margin">
            <div class="widget-body no-padding">
                <div class="widget-main no-margin no-padding">
                    <div class="dialogs no-margin no-padding">
                        <div class="sidebar-shortcuts" id="sidebar-shortcuts">
                            <div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
                                <b style="display: inline-block;margin-right: 25px; font-size:14px;color: darkturquoise; ">好友列表</b>

                                <button id="add_player" class="btn btn-warning">
                                    <i class="fas fa-user-plus"></i>
                                </button>

                                <button id="add_group" class="btn btn-info">
                                    <i class="fas fa-folder-plus"></i>
                                </button>
                            </div>
                        </div><!-- /.sidebar-shortcuts -->
                        <div id="accordion" class="accordion-style1 panel-group no-margin">
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="main-content">
        <div class="main-content-inner">
            <div class="page-content no-padding-bottom">
                <div class="row">

                    <div id="menu-container">
                        <ul id="menu" style="display: none;">
                            <li class="ui-state-disabled">邀请加入游戏</li>
                            <li id="send-message">发送信息</li>
                            <li class="ui-state-disabled">观战</li>
                            <li id="menu-profile">查看详情</li>
                            <li id="modify-note">编辑备注</li>
                            <li>
                                移动至分组
                                <ul id="menu-group-list">
                                </ul>
                            </li>
                            <li id="delete-friend">解除好友关系</li>
                        </ul>
                    </div>


                    <ul id="right-click-menu" style="display: none;">
                        <li id="modify-group-name">修改分组名</li>
                        <li id="delete-group">删除分组</li>
                    </ul>

                    <div id="player-dialog" class="dialog-container">
                        <div class="widget-box no-padding no-margin dialog-left-part">
                            <div class="widget-body">
                                <div id="widget-dialog-user-list" class="widget-main no-padding">
                                    <ul id="dialog-user-list" class="list-group" style="cursor: pointer;">
                                        <li class="list-group-item active">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="user avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item ">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item ">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                        <li class="list-group-item">
                                            <img src="assets/images/avatars/avatar.png" class="round-img"
                                                 alt="Alex's Avatar"/>
                                            <span class="menu-text"> Test_username </span>
                                            <i class="ace-icon glyphicon glyphicon-remove pull-right margin-top16 cross"
                                               style="display: none"></i>
                                        </li>
                                    </ul>

                                </div>
                            </div>
                        </div>
                        <div class="widget-box no-padding no-margin dialog-right-part">
                            <div class="widget-header widget-header-large">
                                <div class="widget-title lighter smaller">
                                    <img src="assets/images/avatars/avatar.png" class="widget-title-round-img"/>
                                    <h4 class="widget-title-text">Test_username</h4>
                                </div>
                                <div class="widget-toolbar">
                                    <i id="player-dialog-collapse" class="ace-icon fa fa-chevron-up"
                                       style="cursor: pointer"></i>
                                </div>
                            </div>

                            <div class="widget-body">
                                <div class="widget-main no-padding">
                                    <div id="dialog-content">
                                        <div class="message-wrapper">
                                            <p class="message-to-me no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-other no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-me no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-other no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="time-stamp">
                                            2018.11.29 13:50
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-me no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-other no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-me no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="message-wrapper">
                                            <p class="message-to-other no-margin">test message aslbfbof </p>
                                            <div class="clearfix"></div>
                                        </div>

                                    </div>
                                </div><!-- /.widget-main -->
                                <form class="no-margin">
                                    <div class="form-actions no-margin">
                                        <input type="text"
                                               class="form-control" name="message"/>
                                    </div>
                                </form>
                            </div><!-- /.widget-body -->
                        </div>
                    </div>

                    <div id="info-widget" class="widget-box no-padding no-margin col-xs-2"
                         style="position: absolute;z-index: 1000;display: none;">
                        <div class="widget-header">
                            <div class="widget-title lighter smaller" style="display: inline-block;">
                                <b>消息通知</b>
                            </div>
                            <div class="widget-toolbar">
                                <i class="ace-icon fa fa-chevron-up" style="cursor: pointer"></i>
                            </div>
                        </div>
                        <div class="widget-body" style="padding-top: 1px;">
                            <div class="widget-main no-padding">
                            </div>
                        </div>
                    </div>

                    <div id="game-lobby" class="widget-box no-margin" style="background: rgb(5,67,108);">
                        <div class="widget-body">
                            <div id="game-lobby-content" class="no-margin no-padding"
                                 style="background: rgb(5,67,108);">
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-inner">
            <div class="footer-content">
                <span class="bigger-120">
                    <span class="blue bolder">五子棋游戏系统</span>
                    version 0.0.1
                </span>
            </div>
        </div>
    </div>


</div>

<!-- basic scripts -->

<script src="assets/js/jquery-2.1.4.min.js"></script>

<!--[if IE]>
<script src="assets/js/jquery-1.11.3.min.js"></script>
<![endif]-->
<script type="text/javascript">
    if ('ontouchstart' in document.documentElement) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>" + "<" + "/script>");
</script>
<script src="assets/js/bootstrap.min.js"></script>

<!-- page specific plugin scripts -->
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
<script src="assets/js/jquery-ui.custom.min.js"></script>
<script src="assets/js/jquery.slimscroll.min.js"></script>
<script src="assets/js/bootbox.js"></script>
<script src="assets/layui/layui.all.js"></script>
<script src="assets/js/md5.js"></script>

<!--[if lte IE 8]>
<script src="assets/js/excanvas.min.js"></script>
<![endif]-->
<script src="assets/js/jquery-ui.custom.min.js"></script>
<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
<script src="assets/js/jquery.easypiechart.min.js"></script>
<script src="assets/js/jquery.sparkline.index.min.js"></script>
<script src="assets/js/jquery.flot.min.js"></script>
<script src="assets/js/jquery.flot.pie.min.js"></script>
<script src="assets/js/jquery.flot.resize.min.js"></script>

<!-- ace scripts -->
<script src="assets/js/ace-elements.min.js"></script>
<script src="assets/js/ace.min.js"></script>

<!-- inline scripts related to this page -->
<script type="text/javascript">
    $(document).ready(function(){
        // $.post("CheckLoginStatus", {}, function (obj) {
        //     var json = eval('(' + obj + ')');
        //     if (json.status == "True") {
        //         console.log("用户已登陆!")
        //     }
        //     if (json.status == "False") {
        //         window.location.href = "Login.html";
        //     }
        // });
    });
    $(function () {
        window.onbeforeunload = function () {
            ws.close();
        };
        getInitData();
        init();

        //分组右键事件
        $(document).on('mousedown','#accordion > div > div >h4.panel-title',function (e) {
            if(3 == e.which){
                $("#right-click-menu").show();
                var top=$(this).offset().top-45;
                $("#right-click-menu").css("position", "absolute").css("top", top).css("left", 0).css("z-index", 1000);
                $("#right-click-menu").data("group-name",$(this).text().replace(/\s+/g,""));
                if($(this).text().replace(/\s+/g,"")=="我的好友"){
                    $("#modify-group-name").addClass("ui-state-disabled").attr("disabled",true);
                    $("#delete-group").addClass("ui-state-disabled").attr("disabled",true);
                }else{
                    $("#modify-group-name").removeClass("ui-state-disabled").attr("disabled",false);
                    $("#delete-group").removeClass("ui-state-disabled").attr("disabled",false);
                }
                $("#menu").hide();
                e.stopPropagation();
            }
        });

        //侧边栏好友选项中点击事件
        $(document).on('click', '.show-menu', function (ev) {
            $("#menu").show();
            var dd_item = $(this).parent().parent();
            var top = dd_item.offset().top - 45;
            $("#menu").css("position", "absolute").css("top", top).css("left", 0).css("z-index", 1000);
            $("#menu").data("friend-id",dd_item.data("friend-id")).data("friend-username",dd_item.data("friend-username"));
            $("#menu-group-list>li").each(function () {
                $(this).removeClass("ui-state-disabled");
            });
            out:
            for(var key in InitData["friendData"]){
                for(var i=0;i<InitData["friendData"][key].length;i++){
                    if(dd_item.data("friend-id")==InitData["friendData"][key][i]["friendId"]){
                        $("[data-content='"+key+"']").addClass("ui-state-disabled");
                        break out;
                    }
                }
            }
            $("#right-click-menu").hide();
            ev.stopPropagation();
        });

        //menu中点击事件
        $("#menu-container").on("click","#menu",function (e) {
            $("#menu").show();
            e.stopPropagation();
        });

        $("#menu-container").on("click","#modify-note",function (e) {
            $("#menu").hide();
            e.stopPropagation();
            layer.prompt({
                title:'请输入备注',
                yes:function (index, layero) {
                    var value = layero.find(".layui-layer-input").val().replace(/\s+/g,"");
                    var reg = new RegExp("^.{0,10}$");
                    if(!reg.test(value)){
                        alert("备注最大长度为10位！");
                        return;
                    }
                    var friendId=$("#menu").data("friend-id");
                    $.ajax({
                        url:"http://localhost:1001/ModifyNote",
                        type:"POST",
                        data:{friendId:friendId,note:value},
                        success:function (obj) {
                            InitData=eval('(' + obj + ')');
                            loadSlideBar();
                        }
                    });
                    layer.close(index);
                }
            });
        });

        $("#menu-container").on("click","#send-message",function (e) {
            var dialog_left = $("#top-open-dialog").offset().left - 132 - 550;
            $(".dialog-container").css("top", 0).css("left", dialog_left).show();
            $('#dialog-content').slimScroll({
                height: '241px',
                start: 'bottom'
            });
            $("#menu").hide();
            $("#info-widget").hide();
            e.stopPropagation();
        });

        $("#menu-container").on("click","#menu-profile",function (e) {
            var username=$("#menu").data("friend-username");
            layer.open({
                area: ['500px', '600px'],
                type: 2,
                content: 'localhost:1001/ProfilePage.html?username='+username
            });
            $("#menu").hide();
            e.stopPropagation();
        });

        $("#menu-container").on("click","#delete-friend",function (e) {
            layer.confirm('是否要删除好友',{title:'提示'}, function(index){
                var friendId=$("#menu").data("friend-id");
                $.ajax({
                    type:"POST",
                    data:{friendId:friendId},
                    url:"http://localhost:1001/DeleteFriend",
                    success:function (obj) {
                        var returnJson=eval('(' + obj + ')');
                        if(returnJson["status"]=="00"){
                            getInitData();
                            loadSlideBar();
                        }
                    }
                });
                console.log(friendId);
                layer.close(index);
            });
            $("#menu").hide();
            e.stopPropagation();
        });


        $("#menu-container").on("click","#menu-group-list > li",function (e) {
            var friendId=$("#menu").data("friend-id");
            var groupName=$(this).data("content");
            $.ajax({
                type:"POST",
                data:{friendId:friendId,groupName:groupName},
                url:"http://localhost:1001/MoveToGroup",
                success:function (obj) {
                    InitData = eval('(' + obj + ')');
                    loadSlideBar();
                }
            });
            $("#menu").hide();
            e.stopPropagation();
        });

        //right-click-menu中的事件
        $("#delete-group").click(function (e) {
            var value=$("#right-click-menu").data("group-name");
            if(value!="我的好友"){
                $.ajax({
                    url:"localhost:1001/DeleteGroup",
                    type:"POST",
                    data:{groupName:value},
                    success:function (obj) {
                        InitData=eval('(' + obj + ')');
                        loadSlideBar();
                        loadMenu();
                    }
                });
            }
        });

        //顶部用户栏点击事件
        $("#setting").click(function () {

            layer.open({
                area: ['500px', '600px'],
                type: 2,
                content: 'localhost:1001/SettingPage.html',
                btn: ['确认', '取消'],
                yes: function(index, layero){
                    var reg = new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$");
                    var iframeWin = window[layero.find('iframe')[0]['name']];
                    var avatar=iframeWin.selectedFile;
                    var birthday=layer.getChildFrame('#form-field-date', index).val();
                    var sex=layer.getChildFrame("#sex-radio>label>input:checked", index).val();
                    var email=layer.getChildFrame("#form-field-email", index).val();
                    var qq=layer.getChildFrame("#form-field-qq", index).val();
                    var password1=layer.getChildFrame("#form-field-pass1", index).val();
                    var password2=layer.getChildFrame("#form-field-pass2", index).val();
                    if(isEmpty(birthday)){
                        alert("生日不能空！");
                        return;
                    }
                    if(isEmpty(sex)){
                        alert("性别必选！");
                        return;
                    }
                    if(isEmpty(email)){
                        alert("邮箱不能空！");
                        return;
                    }
                    if (!reg.test(email)) {
                        alert("邮箱格式不正确！");
                        return;
                    }
                    if(isEmpty(qq)){
                        alert("qq号不能空");
                        return;
                    }
                    if (password1 != password2) {
                        alert("两次输入的密码不同！");
                        return;
                    }else {
                        if(password1!="" && password2!=""){
                            //发送重置密码请求
                            var username=InitData["userData"]["username"];
                            var code = hex_md5(username + password1);
                            $.post("ResetPassword", {"username": username, "code": code});
                        }
                    }
                    if(avatar!=null){
                        var formData = new FormData();
                        formData.append('avatar', avatar);
                        $.ajax({
                            type:"POST",
                            url:"localhost:1001/ModifyUserAvatar",
                            data:formData,
                            contentType: false,
                            processData: false
                        });
                    }
                    $.ajax({
                        type:"POST",
                        url:"localhost:1001/ModifyUserInfo",
                        data:{birthday:birthday,sex:sex,email:email,qq:qq}
                    });
                    //更新首页用户头像
                    getInitData();
                    $("#navbar-container > div.navbar-buttons.navbar-header.pull-right > ul > li.light-blue.dropdown-modal > a > img").attr("src",InitData["userData"]["avatar"]);
                    layer.close(index);
                }
            })
        });

        $("#profile").click(function () {
            layer.open({
                area: ['500px', '600px'],
                type: 2,
                content: 'localhost:1001/ProfilePage.html?username='+InitData["userData"]["username"]
            })
        });

        $("#logout").click(function () {
            $.ajax({
                type:"POST",
                url:"http://localhost:1001/Logout"
            })
        });


        // slider-bar点击非按钮部分隐藏menu
        // window.onmousedown = function (ev) {
        //     var element = ev.target;
        //     while (element) {
        //         if (element.id== "menu" || element.id == "show-menu" || element.id=="player-dialog" || element.id=="info-widget") {
        //             console.log("判断成功");
        //             return;
        //         }
        //         element = element.parentNode;
        //     }
        //     $("#menu").hide();
        //     $('#player-dialog').hide();
        //     $("#info-widget").hide();
        // }; 此方法为最初的原始方法，占用系统资源较多当dom节点较多click次数较多的情况下可能会导致程序崩溃

        //最新方法通过在body节点中绑定hide事件，然后在menu显示的地方使用stopPropagation函数取消 body中的hide事件冒泡
        document.body.onclick = function () {
            $("#menu").hide();
            $("#right-click-menu").hide();
            $('#player-dialog').hide();
            $("#info-widget").hide();
        };

        //顶部按钮点击事件
        $('#player-dialog').click(function (e) {
            $('#player-dialog').show();
            e.stopPropagation();
        });

        $('#info-widget').click(function (e) {
            $('#info-widget').show();
            e.stopPropagation();
        });

        //侧边栏toolbar按钮点击事件
        $("#add_player").click(function () {
            layer.prompt({
                    title: '请输入好友昵称'
                }, function (value, index, elem) {
                    if(value==InitData["userData"]["username"]){
                        alert("不可以加自己为好友哦！");
                        return;
                    }
                    $.ajax({
                        url:"localhost:1001/AddFriend",
                        type:"POST",
                        data:{username:value},
                        success:function (str) {
                            var returnJson=eval('(' + str + ')');
                            if(returnJson["status"]=="00"){
                                alert("好友请求已发送至" + value);
                            }else{
                                if(returnJson["status"]=="01"){
                                    alert("该用户不存在！");
                                }else{
                                    if(returnJson["status"]=="02"){
                                        alert("该用户已为您的好友！");
                                    }else {
                                        alert("您已向该用户发送过请求！");
                                    }
                                }
                            }
                        }
                    });
                    layer.close(index);
                }
            );
        });

        $("#add_group").click(function () {
            layer.prompt({
                    title: "请输入分组名"
                }, function (value, index) {
                    value=value.replace(/\s+/g,"");
                    var reg = new RegExp(".{1,6}");
                    var reg2=new RegExp("^[0-9]");
                    if(reg2.test(value)){
                        alert("分组名不能以数字开头！");
                        return;
                    }
                    if(!reg.test(value)){
                        alert("分组名最大长度为6位！");
                        return;
                    }
                    for(var groupName in InitData["friendData"]){
                        if(groupName==value){
                            alert("分组名不能与已有分组名相同！");
                            return;
                        }
                    }
                    $.ajax({
                        url:"localhost:1001/AddGroup",
                        type:"POST",
                        data:{groupName:value},
                        success:function (obj) {
                            InitData=eval('(' + obj + ')');
                            loadSlideBar();
                            loadMenu();
                        }
                    });
                    layer.close(index);
                }
            );
        });
        
        //信息通知框相关js
        $("#top-open-info").click(function (ev) {
            var info_width = $("#info-widget").width();
            var slide_width = $("#sidebar").width();
            var info_left = $("#top-open-info").offset().left - info_width - slide_width + $("#top-open-info").parent().width();
            $("#info-widget").css("top", 0).css("left", info_left).show();
            $('#player-dialog').hide();
            ev.stopPropagation();
        });

        $("#info-widget>.widget-header>.widget-toolbar>i").click(function (e) {
            $("#info-widget").hide();
            e.stopPropagation();
        });

        //消息通知同意与拒绝的按钮事件
        $("#info-widget").on("click",".agree",function () {
            var fromId= $(this).parent().parent('.alert').data("from-id");
            console.log(fromId);
            $.ajax({
                type:"POST",
                url:"localhost:1001/AgreeAddFriend",
                data:{fromId:fromId},
                success:function (obj) {
                    var returnJson=eval('(' + obj + ')');
                    if(returnJson["status"]=="00"){
                        getInitData();
                        loadInfoList();
                        loadSlideBar();
                    }
                }
            })
        });
        $("#info-widget").on("click",".deny",function () {
            var fromId= $(this).parent().parent('.alert').data("from-id");
            $.ajax({
                type:"POST",
                url:"localhost:1001/DenyAddFriend",
                data:{fromId:fromId},
                success:function (obj) {
                    var returnJson=eval('(' + obj + ')');
                    if(returnJson["status"]=="00"){
                        getInitData();
                        loadInfoList();
                    }
                }
            })
        });

        //对话框相关js
        $("#widget-dialog-user-list").ace_scroll({size: 368});

        $('#dialog-user-list>.list-group-item').mouseover(function () {
            $(this).find("i").show();
        });

        $('#dialog-user-list>.list-group-item').mouseout(function () {
            $(this).find("i").hide();
        });

        $('.cross').click(function (ev) {
            var preview = $(this).parent(".list-group-item").prevAll();
            var next = $(this).parent(".list-group-item").nextAll();
            if (preview.length == 0 && next.length == 0) {
                $('#player-dialog').hide();
            }
            $(this).parent(".list-group-item").remove();
            ev.stopPropagation();
        });

        $('#dialog-user-list>.list-group-item').click(function (ev) {
            var item = $('#dialog-user-list>.list-group-item');
            item.each(function () {
                $(this).removeClass("active");
            });
            $(this).addClass("active");
            ev.stopPropagation();
        });

        $("#top-open-dialog").click(function (ev) {
            var dialog_left = $("#top-open-dialog").offset().left - 132 - 550;
            $(".dialog-container").css("top", 0).css("left", dialog_left).show();
            $('#dialog-content').slimScroll({
                height: '241px',
                start: 'bottom'
            });
            $("#info-widget").hide();
            ev.stopPropagation();
        });

        $("#player-dialog-collapse").click(function (ev) {
            $(".dialog-container").hide();
            ev.stopPropagation();
        });

        //游戏大厅相关js
        $("#game-lobby-content").on("click",".player-holder-right, .player-holder-left",function () {
            var position="";
            if($(this).hasClass("player-holder-right")){
                position="right";
            }else{
                position="left";
            }
            var tableId=$(this).parents(".table-wrapper").data("table-id");
            $.ajax({
                type:"POST",
                url:"http://localhost:1001/SitDown",
                data:{position:position,tableId:tableId},
                success:function (obj) {
                    var returnJson=eval('(' + obj + ')');
                    if(returnJson["status"]=="01"){
                        alert("已经处于游戏状态无法换桌");
                    }
                }
            });

        })
    });

    //获取初始数据
    function getInitData() {
        $.ajax({
            type:"get",
            url:"http://localhost:1001/GetInitData",
            async: false,
            success:function (obj) {
                InitData = eval('(' + obj + ')');
            }
        });
    }

    //加载menu此处必须删除原页面上的menu元素然后重新使用jquery ui的方法去初始化，

    function loadMenu(){
        $("#menu").remove();
        $("#menu-container").append(oldMenuHtml);
        loadMenuGroupList();
        $("#menu").menu();

    }

    //加载好友列表
    function loadSlideBar(){
        $('#accordion').empty();
        for (var groupName in InitData["friendData"]) {
            var htmlContent = "<div class=\"panel panel-default\">\n" +
                "                                <div class=\"panel-heading\">\n" +
                "                                    <h4 class=\"panel-title\">\n" +
                "                                        <a class=\"accordion-toggle collapsed\" data-toggle=\"collapse\"\n" +
                "                                           data-parent=\"#accordion\"\n" +
                "                                           href=\"#" + groupName + "\" style=\"font-weight: 700;\">\n" +
                "                                            <i class=\"ace-icon fa fa-angle-right bigger-110\"\n" +
                "                                               data-icon-hide=\"ace-icon fa fa-angle-down\"\n" +
                "                                               data-icon-show=\"ace-icon fa fa-angle-right\"></i>\n" +
                "                                            &nbsp;" + groupName + "\n" +
                "                                        </a>\n" +
                "                                    </h4>\n" +
                "                                </div>\n" +
                "                                <div class=\"panel-collapse collapse\" id=\"" + groupName + "\">\n" +
                "                                    <div class=\"panel-body no-padding\">\n" +
                "                                        <div class=\"dd\" id=\"nestable\">\n" +
                "                                            <ol class=\"dd-list\">\n";
            for (var i = 0; i < InitData["friendData"][groupName].length; i++) {
                var friend = InitData["friendData"][groupName][i];
                var state;
                switch(friend["state"]){
                    case 0:
                        state="离线";
                        break;
                    case 1:
                        state="在线";
                        break;
                    case 2:
                        state="游戏中";
                        break;
                }
                var bubble;
                switch(friend["loginState"]){
                    case 0:
                        bubble="far";
                        break;
                    case 1:
                        bubble="fas";
                        break;
                }

                var title;
                if(friend["note"]!=undefined && friend["note"]!="" && friend["note"]!=null){
                    title="title=\""+friend["note"]+"\"";
                }else {
                    title="";
                }

                var innerHtmlContent =
                    "                                               <li class=\"dd-item \" "+title+" data-friend-id=\""+friend["friendId"]+"\" data-friend-username=\""+friend["friendUsername"]+"\">\n" +
                    "                                                    <div class=\"dd-handle slide-dd-handler\">\n" +
                    "                                                        <i class=\""+bubble+" fa-lightbulb bigger-140 pull-left margin-top8 margin-right5\"></i>\n" +
                    "                                                        <img class=\"slide-img\" src=\"" + friend["avatar"] + "\" />\n" +
                    "                                                        <div style=\"display: inline-block;font-size: 12px;\">\n" +
                    "                                                            <div>" + friend["friendUsername"] + "</div>\n" +
                    "                                                            <div style=\"color: gray;\">" + state + "</div>\n" +
                    "                                                        </div>\n" +
                    "                                                        <span class=\"fas fa-angle-right pull-right bigger-140 margin-top8 show-menu\"></span>\n" +
                    "                                                    </div>\n" +
                    "                                                </li>\n";
                htmlContent = htmlContent + innerHtmlContent;

            }
            htmlContent +
            "                                            </ol>\n" +
            "                                        </div>\n" +
            "                                    </div>\n" +
            "                                </div>\n" +
            "                            </div>";
            $('#accordion').append(htmlContent);
        }
    }

    //加载menu中group-list
    function loadMenuGroupList() {
        $("#menu-group-list").empty();
        for(var key in InitData["friendData"]){
            $("#menu-group-list").append("<li data-content=\""+key+"\">"+key+"</li>");
        }
    }
    //加载通知列表
    function loadInfoList(){
        $("#top-open-info>i").removeClass("icon-animated-bell");
        $("#top-open-info>.badge").remove();
        $("#info-widget>.widget-body>.widget-main>.scroll-content").empty();
        var notificationList=InitData["notificationData"];
        var infoNumber=notificationList.length;
        if(infoNumber!=0){
            $("#top-open-info>i").addClass("icon-animated-bell");
            $("#top-open-info").append("<span class=\"badge badge-important\">"+infoNumber+"</span>");
            for(var i=0;i<infoNumber;i++){
                $("#info-widget>.widget-body>.widget-main>.scroll-content").append("<div data-from-id=\""+notificationList[i]["fromId"]+"\" class=\"alert alert-block alert-info margin-top5 no-margin-bottom\">\n" +
                    "                                    <p>\n" +
                    "                                        <strong>\n" +
                    "                                            "+notificationList[i]["fromUsername"]+"\n" +
                    "                                        </strong>\n" +
                    "                                        请求添加您为好友\n" +
                    "                                    </p>\n" +
                    "\n" +
                    "                                    <p>\n" +
                    "                                        <button class=\"btn btn-sm btn-success pull-left agree\"><i\n" +
                    "                                                class=\"ace-icon fa fa-check\"></i>同意\n" +
                    "                                        </button>\n" +
                    "                                        <button class=\"btn btn-sm pull-right deny\"><i\n" +
                    "                                                class=\"ace-icon fa fa-times red2\"></i>拒绝\n" +
                    "                                        </button>\n" +
                    "                                        <div class=\"clearfix\"></div>\n" +
                    "                                    </p>\n" +
                    "\n" +
                    "                                </div>");
            }
        }
    }
    //加载game-table
    function loadGameTable(height) {
        var game_lobby_content = $("#game-lobby-content");
        game_lobby_content.empty();
        var gameTableData=InitData["gameTableData"];
        for (var i = 1; i <= 100; i++) {
            var tableInfo=gameTableData[i-1];
            var insertHtml = "<div class=\"table-wrapper\" data-table-id=\""+i+"\">\n" +
                "                                    <p class=\"no-margin player-name-left\" >";
            if (tableInfo["leftUsername"]!=null){
                insertHtml=insertHtml+tableInfo["leftUsername"]+"</p>\n" +
                    "                                    <div class=\"table-wrapper-main\">\n"+
                    "                                        <div class=\"center player-holder-left-hp\">\n" +
                    "                                            <img class=\"player-holder-image\" src=\""+tableInfo["leftAvatar"]+"\"  alt=\"user avatar\"/>\n" +
                    "                                        </div>\n" ;
            }
            else {
                insertHtml=insertHtml+"</p>\n" +
                    "                                    <div class=\"table-wrapper-main\">\n"+
                    "                                        <div class=\"center player-holder-left\">\n" +
                    "                                            <span class=\"fas fa-question\"></span>\n" +
                    "                                        </div>\n" ;
            }
            if(tableInfo["gameState"]==0){
                insertHtml=insertHtml+"                                        <img  class=\"img-table\" src=\"assets\\images\\game_table.png\">\n"
            }else {
                insertHtml=insertHtml+"                                        <img  class=\"img-table\" src=\"assets\\images\\start_table.png\">\n"
            }
            if(tableInfo["rightUsername"]!=null){
                insertHtml=insertHtml+"                                        <div class=\"center player-holder-right-hp\">\n" +
                    "                                             <img class=\"player-holder-image\" src=\""+tableInfo["rightAvatar"]+"\" alt=\"user avatar\"/>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <p class=\"player-name-right\">"+tableInfo["rightUsername"]+"</p>\n"
            }else{
                insertHtml=insertHtml+"                                        <div class=\"center player-holder-right\">\n" +
                    "                                            <span class=\"fas fa-question\"></span>\n" +
                    "                                        </div>\n" +
                    "                                    </div>\n" +
                    "                                    <p class=\"player-name-right\"></p>\n"
            }
            insertHtml=insertHtml+"                                    <p class=\"table-id\">-" + i + "-</p>\n" +
                "                                </div>";
            game_lobby_content.append(insertHtml);
        }
        $('#game-lobby-content').ace_scroll({
            size: height
        });
    }

    //页面初始化
    function init() {
        //页面初始设置
        var height = window.innerHeight - 75 - 45;
        $("#sidebar>div").css("height", height);
        $("#game-lobby").css("height", height - 8);
        $("#info-widget>.widget-body>.widget-main").ace_scroll({size: 305});
        //全局禁止鼠标右击事件
        document.oncontextmenu = function() {
            return false;
        };

        //建立websocket连接
        ws=new WebSocket("ws://localhost:1001/HomeWebSocket");
        ws.onopen=function(){
            ws.send("hello world!");
        };
        ws.onmessage=function(e){
            var data= eval('(' + e.data + ')');
            if(data["type"]=="01"){
                getInitData();
                loadSlideBar();
            }
            if(data["type"]=="02"){
                getInitData();
                loadInfoList();
            }
            // if(data["type"]=="03"){
            //     getInitData();
            //     loadInfoList();
            // }
            //接受后台信息更新game-table
            if(data["type"]=="04"){
                var refreshData=data["refreshData"];
                for (var key in refreshData){
                    var temp=refreshData[key];
                    var tableWrapper=$("div[data-table-id='"+temp["tableId"]+"']");
                    var tableWrapperMain=tableWrapper.children(".table-wrapper-main");
                    tableWrapperMain.children(":first").remove();
                    if(temp["leftUsername"]==null){
                        var insertHtml="<div class=\"center player-holder-left\">\n" +
                            "                                            <span class=\"fas fa-question\"></span>\n" +
                            "                                        </div>";
                        tableWrapperMain.prepend(insertHtml);
                    }else {
                        var insertHtml="<div class=\"center player-holder-left-hp\">\n" +
                            "                                             <img class=\"player-holder-image\" src=\""+temp["leftAvatar"]+"\" alt=\"user avatar\"/>\n" +
                            "                                        </div>";
                        tableWrapperMain.prepend(insertHtml);
                    }
                    tableWrapperMain.children(":last").remove();
                    if(temp["rightUsername"]==null){
                        var insertHtml="<div class=\"center player-holder-right\">\n" +
                            "                                            <span class=\"fas fa-question\"></span>\n" +
                            "                                        </div>";
                        tableWrapperMain.append(insertHtml);
                    }else{
                        var insertHtml="<div class=\"center player-holder-right-hp\">\n" +
                            "                                             <img class=\"player-holder-image\" src=\""+temp["rightAvatar"]+"\" alt=\"user avatar\"/>\n" +
                            "                                        </div>";
                        tableWrapperMain.append(insertHtml);
                    }
                    tableWrapper.children(".player-name-left").text(temp["leftUsername"]);
                    tableWrapper.children(".player-name-right").text(temp["rightUsername"]);
                }
            }
        };


        //修改顶部栏的username
        $("#username").text(InitData["userData"]["username"]);

        //修改用户头像
        $("#navbar-container > div.navbar-buttons.navbar-header.pull-right > ul > li.light-blue.dropdown-modal > a > img").attr("src",InitData["userData"]["avatar"]);

        //加载好友列表
        loadSlideBar();

        //获取原始menu的html
        getOldMenuHtml();

        //menu中group-list加载
        loadMenuGroupList();

        //加载game-table
        loadGameTable(height);

        $('.comments').ace_scroll({
            size: height
        });

        loadInfoList();

        //判断是否第一次登录
        if (InitData["userData"]["ifFirstLogin"] == 1) {
            layer.msg('首次登录，请前往个人信息设置页面，设置个人信息！',{
                offset: 't',
                time:2000
            })
        }

        $("#menu").menu();
        $("#right-click-menu").menu();
    }

    //获取原始状态的menu
    function getOldMenuHtml(){
        oldMenuHtml=$("#menu").prop("outerHTML");
    }
    function isEmpty(obj) {
        if (typeof obj == "undefined" || obj == null || obj == "") {
            return true;
        } else {
            return false;
        }
    }//判断字符串是否为空

</script>
</body>
<script type="text/javascript">

</script>
</html>